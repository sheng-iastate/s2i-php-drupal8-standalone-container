#!/bin/bash

#Populate varibles from secrets mounted in project
DBHOST=$(cat db/hostname)
DBGRANTUSER=$(cat db/username)
DBGRANTUSERPW=$(cat db/password)

SITE=${SITE:-}
DRUPALADMINPASSWORD=${DRUPALADMINPASSWORD:-}


# Check to see if we have everything set
echo "SITE = '$SITE'"

if [ -z $DBHOST ]; then

	echo "No DBHOST set."
	exit 1;

elif [ -z $DBGRANTUSER ]; then
	
	echo "No DBGRANTUSER set."
	exit 1;

elif [ -z $DBGRANTUSERPW ]; then

	echo "No DBGRANTUSERPW set."
	exit 1;

elif [ -z $SITE ]; then
	
	echo "No SITE set."
	exit 1;
	
elif [ -z $DRUPALADMINPASSWORD ]; then
	
	echo "No DRUPALADMINPASSWORD set."
	exit 1;

fi


# copy the build secret key to the home for the builder
mkdir ./.ssh
cp ssh-privatekey ./.ssh/id_rsa
chmod 600 ./.ssh/id_rsa

# Add github to known hosts so the git clones can happen from composer
ssh-keyscan -H github.com >> ./.ssh/known_hosts


set -e

shopt -s dotglob
echo "---> Installing application source..."
mv /tmp/src/* ./

if [ -f composer.json ]; then
  echo "Found 'composer.json', installing dependencies using composer.phar... "

  # Install Composer
  curl https://getcomposer.org/installer | php

  # Change the repo mirror if provided
  if [ -n "$COMPOSER_MIRROR" ]; then
    ./composer.phar config -g repositories.packagist composer $COMPOSER_MIRROR
  fi

  # Install App dependencies using Composer
  ./composer.phar install --no-interaction --no-ansi --optimize-autoloader

  if [ ! -f composer.lock ]; then
    echo -e "\nConsider adding a 'composer.lock' file into your source repository.\n"
  fi
fi


# peform the site install if the variables are there
if [ ! -z $DBHOST ] && [ ! -z $DBGRANTUSER ] && [ ! -z $DBGRANTUSERPW ] && [ ! -z $SITE ] && [ ! -z $DRUPALADMINPASSWORD ] 
then

	PASSWORD=$(env LC_CTYPE=C tr -dc A-Z-a-z-0-9 < /dev/urandom | head -c16)
	
	echo "Drush site install"
	cd web
	drush site-install iastate8 --db-url=mysql://$SITE:$PASSWORD@$DBHOST/$SITE --db-su=$DBGRANTUSER --db-su-pw=$DBGRANTUSERPW --sites-subdir=$SITE --account-pass=$DRUPALADMINPASSWORD --site-name=$SITE -y
	cd
	
fi


# Fix source directory permissions
fix-permissions ./


